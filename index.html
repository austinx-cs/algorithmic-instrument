<body></body>
<script src="https://unpkg.com/tone"></script>
<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://algorithmicmusic.online/js/create-spectrum.js"></script>
<script src="https://algorithmicmusic.online/js/create-waveform.js"></script>
<script>
/* global Tone, nn, d3, createWaveform, createSpectrum */
let rdm = randomize() 

let freqRaw = 440
let volRaw = 1
const pitchOffset = 440

function* randomize () { // co-routine for randomizing synth elements while it plays
  while (true) {
    synth.oscillator.partials = [Math.random(), Math.random(), Math.random(), Math.random(), Math.random(), Math.random(), Math.random(), Math.random(), Math.random()]
    rdmLabel.content(synth.oscillator.partials)
    synth.frequency.value = (Math.random() * pitchOffset - pitchOffset / 2) + freqRaw
    synth.volume.value = volRaw
    yield;
  }
}

const wave = createWaveform()

const synth = new Tone.Synth({
  oscillator: {
    type: 'custom',
    partials: [1, 0, 0, 0, 0, 0, 0, 0, 0]
  },
  envelope: {
    attack: 0.005,
    decay: 0.1,
    sustain: 0.3,
    release: 1
  }
})
synth.toDestination()
synth.connect(wave)

let interval
  
function start () {
  synth.triggerAttack()
  interval = setInterval(rdm, 500)
}

function stop () {
  synth.triggerRelease()
  clearInterval(interval)
}

function update (e) {
  freqRaw = nn.map(e.x, 0, nn.width, 220, 1760)
  volRaw = nn.map(e.y, 0, nn.height, 0, -80)
}

const rdmLabel = nn.create('label')
  .content("pang")
  .addTo('body')
  
nn.on('mousedown', start)
nn.on('mouseup', stop)
nn.on('mousemove', update)
nn.on('keydown', (e) => {
  if (e.key === 'q') rdm.next()
})
nn.on('keydown', (e) => {
  if (e.key === 'w') interval = clearInterval(interval)
})

</script>