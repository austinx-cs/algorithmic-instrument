<body></body>
<script src="https://unpkg.com/tone"></script>
<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://algorithmicmusic.online/js/create-spectrum.js"></script>
<script src="https://algorithmicmusic.online/js/create-waveform.js"></script>
<script>
/* global Tone, nn, d3, createWaveform, createSpectrum */

// declaring globals
let theremin = false
let intervalS
let currRate = 0

// title
nn.create('title')
  .content('false choir')
  .addTo('body')

// synth
const synth = new Tone.PolySynth(Tone.Synth, {maxPolyphony: 4})
synth.set({
  oscillator: {
    type: 'custom',
    partials: [1, 0, 0, 0, 0, 0, 0, 0, 0],
    volume: 0
  },
  envelope: {
    attack: 0.005,
    decay: 0.2,
    sustain: 0.4,
    release: 1
  }
})
const wave = createWaveform()
synth.toDestination()
synth.connect(wave)
const spec = createSpectrum({ range: [20, 7040] })
synth.connect(spec)

// partial object
function Partial() {
  this.p = 0
  this.rising = true
  this.rate = 0
  this.max = 1
  this.interval = null
  this.update = coroutine(function*() {
    while (true) {
      yield
      if (this.p + this.rate >= this.max) {this.rising = false; this.p = this.max}
      else if (this.p - this.rate <= 0) {  this.rising = true; this.p = 0;  }
      else if (this.rising) {  this.p += this.rate  }
      else {  this.p -= this.rate  }
    }
  })
  this.label = null
  this.lUpdate = function(e) {
    let rate = e.target.value
    this.rate = rate
    console.log(this.rate)
    //this.label.content(`rate: ${rate.toFixed(2)}`)
  }
}

// partial object creations
p1 = new Partial()
p2 = new Partial()
p3 = new Partial()
p4 = new Partial()
p5 = new Partial()
p6 = new Partial()
p7 = new Partial()
p8 = new Partial()
partials = [p1, p2, p3, p4, p5, p6, p7, p8]
  
// UI Stuff

function toggleT (e) {
  if (e.target.checked) { theremin = true }
  else { theremin = false }
}

// theremin toggle
nn.create('input')
  .addTo('body')
  .set({ type: 'checkbox' })
  .on('change', toggleT)
nn.create('text')
  .content('toggle theremin controls')
  .addTo('body')
nn.create('br').addTo('body')
nn.create('br').addTo('body')
  
for (let p = 0; p < partials.length; p++) {
  nn.create('text')
    .content('p' + String(p + 1) + ' ')
    .addTo('body')
  partials[p].label = nn.create('label')
    .content('rate: 0 ')
    .addTo('body')
  nn.create('input')
    .set({ type: 'range', value: 0, min: 0, max: partials[p].max, step: 0.01 })
    .addTo('body')
    .on('input', p1.lUpdate)
  nn.create('br').addTo('body')
}

// coroutine base function
function coroutine(func) {
  let coro = func()
  coro.next()
  return function() {
    coro.next()
  }
}

function initLoops() {
  for (let p = 0; p < partials.length; p++) {
    partials[p].interval = setInterval(partials[p].update, currRate)
  }
}

function clearLoops() {
  for (let p = 0; p < partials.length; p++) {
    clearInterval(partials[p].interval)
  }
}

initLoops()

// updating synth with new partials
function* updateSynth() {
  while (true) {
    yield
    // console.log([p1, p2, p3, p4, p5, p6, p7, p8])
    synth.set({
      "oscillator": {
        "type": 'custom',
        "partials": [1, p1, p2, p3, p4, p5, p6, p7, p8]
      }
    })
  }
}
let updS = coroutine(updateSynth)

// functions for theremin controls
let thereminNote
function start() {
  if (theremin) {
    thereminNote = freqRaw
    synth.triggerAttack(thereminNote)
    intervalS = setInterval(updS, 50)
  }
}
function stop() {
  if (theremin) {  
    synth.triggerRelease(thereminNote)
    clearInterval(intervalS)
  }
}
function mouseUpdate (e) {
  if (theremin) {
    freqRaw = nn.map(e.x, 0, nn.width, 220, 1000)
    synth.set({
      "oscillator": {
        "frequency": freqRaw,
        "volume": nn.map(e.y, 0, nn.height, 0, -25)
      }
    })
  }
}

nn.on('mousedown', start)
nn.on('mouseup', stop)
nn.on('mousemove', mouseUpdate)

function keyStart(note) {
  synth.triggerAttack(note)
}

const keyMap = {
  '`': { note: "C3", pressed: false },
  '1': { note: "C#3", pressed: false },
  'q': { note: "D3", pressed: false },
  '2': { note: "D#3", pressed: false },
  'w': { note: "E3", pressed: false },
  'e': { note: "F3", pressed: false },
  '4': { note: "F#3", pressed: false },
  'r': { note: "G3", pressed: false },
  '5': { note: "G#3", pressed: false },
  't': { note: "A3", pressed: false },
  '6': { note: "A#3", pressed: false },
  'y': { note: "B3", pressed: false },
  'u': { note: "C4", pressed: false },
  '8': { note: "C#4", pressed: false },
  'i': { note: "D4", pressed: false },
  '9': { note: "D#4", pressed: false },
  'o': { note: "E4", pressed: false },
  'p': { note: "F4", pressed: false },
  '-': { note: "F#4", pressed: false },
  '[': { note: "G4", pressed: false },
  '=': { note: "G#4", pressed: false },
  ']': { note: "A4", pressed: false },
  'Backspace': { note: "A#4", pressed: false },
  '\\': { note: "B4", pressed: false },
  'z': { note: "C5", pressed: false },
  's': { note: "C#5", pressed: false },
  'x': { note: "D5", pressed: false },
  'd': { note: "D#5", pressed: false },
  'c': { note: "E5", pressed: false },
  'v': { note: "F5", pressed: false },
  'g': { note: "F#5", pressed: false },
  'b': { note: "G5", pressed: false },
  'h': { note: "G#5", pressed: false },
  'n': { note: "A5", pressed: false },
  'j': { note: "A#5", pressed: false },
  'm': { note: "B5", pressed: false },
  ',': { note: "C6", pressed: false },
  'l': { note: "C#6", pressed: false },
  '.': { note: "D6", pressed: false },
  ';': { note: "D#6", pressed: false },
  '/': { note: "E6", pressed: false }
}

function keyStart(e) {
  const obj = keyMap[e.key]
  if (obj && !obj.pressed) {
    synth.triggerAttack(obj.note)
    obj.pressed = true
  }
  intervalS = setInterval(updS, 50)
}

// here we do the inverse of the function above
function release(e) {
  const obj = keyMap[e.key]
  if (obj && obj.pressed) {
    synth.triggerRelease(obj.note)
    obj.pressed = false
  }
}

// keyboard controls
nn.on('keydown', keyStart)
nn.on('keyup', release)

// MIDI controls
function updatePartials(msg) {
  if (msg.chl < 8) {
    if (msg.chl == 0) {
      p1.rate = nn.map(msg.val, 0, 127, 0, p1.max / 2)
      //console.log(p1.rate)
    }
    else if (msg.chl == 1) {
      p2.rate = nn.map(msg.val, 0, 127, 0, p2.max / 2)
      //console.log(p2.rate)
    }
    else if (msg.chl == 2) {
      p3.rate = nn.map(msg.val, 0, 127, 0, p3.max / 2)
      //console.log(p3.rate)
    }
    else if (msg.chl == 3) {
      p4.rate = nn.map(msg.val, 0, 127, 0, p4.max / 2)
      //console.log(p4.rate)
    }
    else if (msg.chl == 4) {
      p5.rate = nn.map(msg.val, 0, 127, 0, p5.max / 2)
      //console.log(p5.rate)
    }
    else if (msg.chl == 5) {
      p6.rate = nn.map(msg.val, 0, 127, 0, p6.max / 2)
      //console.log(p6.rate)
    }
    else if (msg.chl == 6) {
      p7.rate = nn.map(msg.val, 0, 127, 0, p7.max / 2)
      //console.log(p7.rate)
    }
    else if (msg.chl == 7) {
      p8.rate = nn.map(msg.val, 0, 127, 0, p8.max / 2)
      //console.log(p8.rate)
    }
  }
  else if (msg.chl < 23) {
    if (msg.chl == 16) {
      p1.max = nn.map(msg.val, 0, 127, 0, 1)
    }
    else if (msg.chl == 17) {
      p2.max = nn.map(msg.val, 0, 127, 0, 1)
    }
    else if (msg.chl == 18) {
      p3.max = nn.map(msg.val, 0, 127, 0, 1)
    }
    else if (msg.chl == 19) {
      p4.max = nn.map(msg.val, 0, 127, 0, 1)
    }
    else if (msg.chl == 20) {
      p5.max = nn.map(msg.val, 0, 127, 0, 1)
    }
    else if (msg.chl == 21) {
      p6.max = nn.map(msg.val, 0, 127, 0, 1)
    }
    else if (msg.chl == 22) {
      p7.max = nn.map(msg.val, 0, 127, 0, 1)
    }
    else if (msg.chl == 23) {
      p8.max = nn.map(msg.val, 0, 127, 0, 1)
    }
  }
  else if (msg.chl == 42 && msg.val == 127) {
    clearLoops()
  }
  else if (msg.chl == 41 && msg.val == 127) {
    initLoops()
  }
  else if (msg.chl == 45 && msg.val == 127) {
    p1.p = 0
    p2.p = 0
    p3.p = 0
    p4.p = 0
    p5.p = 0
    p6.p = 0
    p7.p = 0
    p8.p = 0
  }
}
nn.MIDI(updatePartials)

// disclaimer text
nn.create('br').addTo('body')
  nn.create('br').addTo('body')
nn.create('text')
  .content('(midi recommended)')
  .addTo('body')
</script>