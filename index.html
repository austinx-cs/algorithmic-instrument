<body></body>
<script src="https://unpkg.com/tone"></script>
<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://algorithmicmusic.online/js/create-spectrum.js"></script>
<script src="https://algorithmicmusic.online/js/create-waveform.js"></script>
<script>
/* global Tone, nn, d3, createWaveform, createSpectrum */

let freqRaw = 440
let volRaw = 0
let intervalN, intervalS
const pitchOffset = 40
const numNotes = 4

const synth = new Tone.Synth({
  oscillator: {
    type: 'custom',
    partials: [1, 0, 0, 0, 0, 0, 0, 0, 0]
  },
  envelope: {
    attack: 0.005,
    decay: 2,
    sustain: 0.7,
    release: 5
  }
})

function coroutine(func) {
  let coro = func()
  coro.next()
  return function() {
    coro.next()
  }
}

const label = nn.create('label')
  .content("pang")
  .addTo('body')

const label2 = nn.create('label')
  .content(" ")
  .addTo('body')

function* pingPong() {
  while (true) {
    yield
    label.content("ping")
    yield
    label.content("pong")
  }
}

function* randomizeNote() { // co-routine for randomizing synth elements while it plays
  while (true) {
    yield
    let rOffset = Math.floor(Math.random() * numNotes) - numNotes / 2
    synth.frequency.value = rOffset * pitchOffset + freqRaw
    //synth.frequency.value = 440
    synth.volume.value = rOffset * 1.5 + volRaw
    // console.log(synth.oscillator.get().frequency)
  }
}

let p1 = 0, p2 = 0, p3 = 0, p4 = 0, p5 = 0, p6 = 0, p7 = 0, p8 = 0
let p1Rising = true
let p2Rising = true
let p3Rising = true
let p4Rising = true
let p5Rising = true
let p6Rising = true
let p7Rising = true
let p8Rising = true
let p1Rate = 0
let p2Rate = 0
let p3Rate = 0
let p4Rate = 0
let p5Rate = 0
let p6Rate = 0
let p7Rate = 0
let p8Rate = 0
let iP1, iP2, iP3, iP4, iP5, iP6, iP7, iP8

function* p1Update() {
  while (true) {
    yield
    if (p1 >= 1) {
      p1Rising = false
    }
    else if (p1 <= 0) {
      p1Rising = true
    }
    if (p1Rising) {
      p1 += p1Rate
    }
    else {
      p1 -= p1Rate
    }
  }
}
  
function* p1Update() {
  while (true) {
    yield
    if (p1 >= 1) {
      p1Rising = false
    }
    else if (p1 <= 0) {
      p1Rising = true
    }
    if (p1Rising) {
      p1 += p1Rate
    }
    else {
      p1 -= p1Rate
    }
  }
}
  
function* p1Update() {
  while (true) {
    yield
    if (p1 >= 1) {
      p1Rising = false
    }
    else if (p1 <= 0) {
      p1Rising = true
    }
    if (p1Rising) {
      p1 += p1Rate
    }
    else {
      p1 -= p1Rate
    }
  }
}
  
function* p1Update() {
  while (true) {
    yield
    if (p1 >= 1) {
      p1Rising = false
    }
    else if (p1 <= 0) {
      p1Rising = true
    }
    if (p1Rising) {
      p1 += p1Rate
    }
    else {
      p1 -= p1Rate
    }
  }
}
  
function* p1Update() {
  while (true) {
    yield
    if (p1 >= 1) {
      p1Rising = false
    }
    else if (p1 <= 0) {
      p1Rising = true
    }
    if (p1Rising) {
      p1 += p1Rate
    }
    else {
      p1 -= p1Rate
    }
  }
}
  
function* p1Update() {
  while (true) {
    yield
    if (p1 >= 1) {
      p1Rising = false
    }
    else if (p1 <= 0) {
      p1Rising = true
    }
    if (p1Rising) {
      p1 += p1Rate
    }
    else {
      p1 -= p1Rate
    }
  }
}
  
function* p1Update() {
  while (true) {
    yield
    if (p1 >= 1) {  p1Rising = false  }
    else if (p1 <= 0) {  p1Rising = true  }
    if (p1Rising) {  p1 += p1Rate  }
    else {  p1 -= p1Rate  }
  }
}

function* p2Update() {
  while (true) {
    yield
    if (p2 >= 1) {  p2Rising = false  }
    else if (p2 <= 0) {  p2Rising = true  }
    if (p2Rising) {  p2 += p2Rate  }
    else {  p2 -= p2Rate  }
  }
}
  
function* p3Update() {
  while (true) {
    yield
    if (p3 >= 1) {  p3Rising = false  }
    else if (p3 <= 0) {  p3Rising = true  }
    if (p3Rising) {  p3 += p3Rate  }
    else {  p3 -= p3Rate  }
  }
}
  
function* p4Update() {
  while (true) {
    yield
    if (p4 >= 1) {  p4Rising = false  }
    else if (p4 <= 0) {  p4Rising = true  }
    if (p4Rising) {  p4 += p1Rate  }
    else {  p4 -= p4Rate  }
  }
}

function* p5Update() {
  while (true) {
    yield
    if (p5 >= 1) {  p5Rising = false  }
    else if (p5 <= 0) {  p5Rising = true  }
    if (p5Rising) {  p5 += p5Rate  }
    else {  p5 -= p5Rate  }
  }
}
  
function* p6Update() {
  while (true) {
    yield
    if (p6 >= 1) {  p6Rising = false  }
    else if (p6 <= 0) {  p6Rising = true  }
    if (p6Rising) {  p6 += p6Rate  }
    else {  p6 -= p6Rate  }
  }
}
  
function* p7Update() {
  while (true) {
    yield
    if (p7 >= 1) {  p7Rising = false  }
    else if (p7 <= 0) {  p7Rising = true  }
    if (p7Rising) {  p7 += p7Rate  }
    else {  p7 -= p7Rate  }
  }
}
  
function* p8Update() {
  while (true) {
    yield
    if (p8 >= 1) {  p8Rising = false  }
    else if (p8 <= 0) {  p8Rising = true  }
    if (p8Rising) {  p8 += p8Rate  }
    else {  p8 -= p8Rate  }
  }
}
  
let p1Up = coroutine(p1Update)
let p2Up = coroutine(p2Update)
let p3Up = coroutine(p3Update)
let p4Up = coroutine(p4Update)
let p5Up = coroutine(p5Update)
let p6Up = coroutine(p6Update)
let p7Up = coroutine(p7Update)
let p8Up = coroutine(p8Update)

let currRate = 100

function initLoops() {
  iP1 = setInterval(p1Up, currRate)
  iP2 = setInterval(p2Up, currRate)
  iP3 = setInterval(p3Up, currRate)
  iP4 = setInterval(p4Up, currRate)
  iP5 = setInterval(p5Up, currRate)
  iP6 = setInterval(p6Up, currRate)
  iP7 = setInterval(p7Up, currRate)
  iP8 = setInterval(p8Up, currRate)
}

function clearLoops() {
  clearInterval(iP1)
  clearInterval(iP2)
  clearInterval(iP3)
  clearInterval(iP4)
  clearInterval(iP5)
  clearInterval(iP6)
  clearInterval(iP7)
  clearInterval(iP8)
}

initLoops()

function* updateSynth() {
  while (true) {
    yield
    //console.log([1, p1, p2, p3, p4, p5, p6, p7, p8])
    synth.oscillator.partials = [1, p1, p2, p3, p4, p5, p6, p7, p8]
  }
}
  
let rdmN = coroutine(randomizeNote)
let updS = coroutine(updateSynth)
let tester = coroutine(pingPong)

//setInterval(tester, 500)

const wave = createWaveform()

synth.toDestination()
synth.connect(wave)
  
function start () {
  synth.triggerAttack()
  //intervalN = setInterval(rdmN, 500)
  intervalS = setInterval(updS, 50)
}

function stop () {
  synth.triggerRelease()
  clearInterval(intervalN)
  clearInterval(intervalS)
}

function mouseUpdate (e) {
  freqRaw = nn.map(e.x, 0, nn.width, 220, 1000)
  volRaw = nn.map(e.y, 0, nn.height, 0, -25)
  synth.frequency.value = freqRaw
  synth.volume.value = volRaw
}
  
function updatePartials (msg) {
  if (msg.chl < 8) {
    if (msg.chl == 0) {
      p1Rate = nn.map(msg.val, 0, 127, 0, 1)
      //console.log(p1Rate)
    }
    else if (msg.chl == 1) {
      p2Rate = nn.map(msg.val, 0, 127, 0, 1)
      //console.log(p2Rate)
    }
    else if (msg.chl == 2) {
      p3Rate = nn.map(msg.val, 0, 127, 0, 1)
      //console.log(p3Rate)
    }
    else if (msg.chl == 3) {
      p4Rate = nn.map(msg.val, 0, 127, 0, 1)
      //console.log(p4Rate)
    }
    else if (msg.chl == 4) {
      p5Rate = nn.map(msg.val, 0, 127, 0, 1)
      //console.log(p5Rate)
    }
    else if (msg.chl == 5) {
      p6Rate = nn.map(msg.val, 0, 127, 0, 1)
      //console.log(p6Rate)
    }
    else if (msg.chl == 6) {
      p7Rate = nn.map(msg.val, 0, 127, 0, 1)
      //console.log(p7Rate)
    }
    else if (msg.chl == 7) {
      p8Rate = nn.map(msg.val, 0, 127, 0, 1)
      //console.log(p8Rate)
    }
  }
  else if (msg.chl == 42 && msg.val == 127) {
    clearLoops()
  }
  else if (msg.chl == 41 && msg.val == 127) {
    initLoops()
  }
  else if (msg.chl == 45 && msg.val == 127) {
    p1 = 0
    p2 = 0
    p3 = 0
    p4 = 0
    p5 = 0
    p6 = 0
    p7 = 0
    p8 = 0
  }
}

// run the function every time we receive a new MIDI message
nn.MIDI(updatePartials)
  
nn.on('mousedown', start)
nn.on('mouseup', stop)
nn.on('mousemove', mouseUpdate)
  
</script>