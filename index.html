<body></body>
<script src="https://unpkg.com/tone"></script>
<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://algorithmicmusic.online/js/create-spectrum.js"></script>
<script src="https://algorithmicmusic.online/js/create-waveform.js"></script>
<script>
/* global Tone, nn, d3, createWaveform, createSpectrum */

let freqRaw = 440
let volRaw = 0
let intervalN, intervalS
const pitchOffset = 40
const numNotes = 8

const synth = new Tone.Synth({
  oscillator: {
    type: 'custom',
    partials: [1, 0, 0, 0, 0, 0, 0, 0, 0]
  },
  envelope: {
    attack: 0.005,
    decay: 2,
    sustain: 0.7,
    release: 5
  }
})

function coroutine(func) {
  let coro = func()
  coro.next()
  return function() {
    coro.next()
  }
}

const label = nn.create('label')
  .content("pang")
  .addTo('body')

const label2 = nn.create('label')
  .content(" ")
  .addTo('body')

function* pingPong() {
  while (true) {
    yield
    label.content("ping")
    yield
    label.content("pong")
  }
}

function* randomizeNote() { // co-routine for randomizing synth elements while it plays
  while (true) {
    yield
    //let rOffset = Math.floor(Math.random() * numNotes) - numNotes / 2
    //synth.frequency.value = rOffset * pitchOffset + freqRaw
    synth.frequency.value = 440
    //synth.volume.value = rOffset * 1.5 + volRaw
    // console.log(synth.oscillator.get().frequency)
  }
}

let p1 = 0, p2 = 0, p3 = 0, p4 = 0, p5 = 0, p6 = 0, p7 = 0, p8 = 0
let p1Rising = true
let p2Rising = true
let p3Rising = true
let p4Rising = true
let p5Rising = true
let p6Rising = true
let p7Rising = true
let p8Rising = true
let p1Rate = 0.1
let p2Rate = 0.1
let p3Rate = 0.1
let p4Rate = 0.1
let p5Rate = 0.1
let p6Rate = 0.1
let p7Rate = 0.1
let p8Rate = 0.1

function* p1Update() {
  while (true) {
    yield
    if (p1 >= 1) {
      p1Rising = false
    }
    else if (p1 <= 0) {
      p1Rising = true
    }
    if (p1Rising) {
      p1 += p1Rate
    }
    else {
      p1 -= p1Rate
    }
  }
}
let p1Up = coroutine(p1Update)
let iP1 = setInterval(p1Up, 50)

function* updateSynth() {
  while (true) {
    yield
    console.log([1, p1, p2, p3, p4, p5, p6, p7, p8])
    synth.oscillator.partials = [1, p1, p2, p3, p4, p5, p6, p7, p8]
  }
}
  
let rdmN = coroutine(randomizeNote)
let updS = coroutine(updateSynth)
let tester = coroutine(pingPong)

//setInterval(tester, 500)

const wave = createWaveform()

synth.toDestination()
synth.connect(wave)
  
function start () {
  synth.triggerAttack()
  intervalN = setInterval(rdmN, 50)
  intervalS = setInterval(updS, 50)
}

function stop () {
  synth.triggerRelease()
  clearInterval(intervalN)
  clearInterval(intervalS)
}

function mouseUpdate (e) {
  freqRaw = nn.map(e.x, 0, nn.width, 220, 2093)
  volRaw = nn.map(e.y, 0, nn.height, 0, -25)
  // synth.frequency.value = freqRaw
  // synth.volume.value = volRaw
}

function updatePartials (msg) {
  if (msg.chl == 0) {
    p1Rate = nn.map(msg.val, 0, 127, 0, 1)
    console.log(p1Rate)
  }
  else if (msg.chl == 1) {
    p2Rate = nn.map(msg.val, 0, 127, 0, 1)
    console.log(p2Rate)
  }
  else if (msg.chl == 2) {
    p3Rate = nn.map(msg.val, 0, 127, 0, 1)
    console.log(p3Rate)
  }
}

// run the function every time we receive a new MIDI message
nn.MIDI(updatePartials)
  
nn.on('mousedown', start)
nn.on('mouseup', stop)
nn.on('mousemove', mouseUpdate)
  
</script>