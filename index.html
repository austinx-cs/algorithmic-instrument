<body></body>
<script src="https://unpkg.com/tone"></script>
<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://algorithmicmusic.online/js/create-spectrum.js"></script>
<script src="https://algorithmicmusic.online/js/create-waveform.js"></script>
<script>
/* global Tone, nn, d3, createWaveform, createSpectrum */

let freqRaw, volRaw, intervalN, intervalS
const pitchOffset = 40
const numNotes = 8

const synth = new Tone.Synth({
  oscillator: {
    type: 'custom',
    partials: [1, 0, 0, 0, 0, 0, 0, 0, 0]
  },
  envelope: {
    attack: 0.005,
    decay: 0.1,
    sustain: 0.3,
    release: 1
  }
})

function* randomizeNote() { // co-routine for randomizing synth elements while it plays
  while (true) {
    let rOffset = (Math.Floor(Math.Random() * numNotes) - numNotes / 2)
    synth.frequency.value = rOffset * pitchOffset + freqRaw
    synth.volume.value = rOffset + volRaw
    synth.envelope.release = Math.Random() * 2 + 1
    yield;
  }
}
  
const lfo1 = new Tone.LFO({
  frequency: 4,
  min: 0,
  max: 1
})

const lfo2 = new Tone.LFO({
  frequency: 4,
  min: 0,
  max: 1
})

const lfo3 = new Tone.LFO({
  frequency: 4,
  min: 0,
  max: 1
})

const lfo4 = new Tone.LFO({
  frequency: 4,
  min: 0,
  max: 1
})

const lfo5 = new Tone.LFO({
  frequency: 4,
  min: 0,
  max: 1
})

const lfo6 = new Tone.LFO({
  frequency: 4,
  min: 0,
  max: 1
})

const lfo7 = new Tone.LFO({
  frequency: 4,
  min: 0,
  max: 1
})

const lfo8 = new Tone.LFO({
  frequency: 4,
  min: 0,
  max: 1
})
  
function* updateSynth() {
  synth.oscillator.partials = [1, lfo1.output, lfo2.output, lfo3.output, lfo4.output, lfo5.output, lfo6.output, lfo7.output, lfo8.output]
  yield
}

let rdmN = randomizeNote() 

let updS = updateSynth()

const wave = createWaveform()

synth.toDestination()
synth.connect(wave)
  
function start () {
  synth.triggerAttack()
  intervalN = setInterval(rdmN, 210)
  intervalS = setInterval(updS, 100)
}

function stop () {
  synth.triggerRelease()
  clearInterval(intervalN)
  clearInterval(intervalS)
}

function mouseUpdate (e) {
  freqRaw = nn.map(e.x, 0, nn.width, 220, 1760)
  volRaw = nn.map(e.y, 0, nn.height, 10, -60)
}
  
//const Label = nn.create('label')
  //.content("hello")
  //.addTo('body')
  
nn.on('mousedown', start)
nn.on('mouseup', stop)
nn.on('mousemove', mouseUpdate)
nn.on('keydown', (e) => {
  if (e.key === 'q') rdm.next()
})
  
</script>